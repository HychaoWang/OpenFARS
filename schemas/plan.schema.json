{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "ExperimentPlan",
  "type": "object",
  "required": [
    "id",
    "hypothesis_id",
    "datasets",
    "models",
    "variables",
    "controls",
    "metrics",
    "ablations",
    "budget",
    "retry_policy"
  ],
  "properties": {
    "id": {"type": "string"},
    "hypothesis_id": {"type": "string"},
    "datasets": {
      "type": "array",
      "items": {"type": "string"},
      "minItems": 1
    },
    "models": {
      "type": "array",
      "items": {"type": "string"},
      "minItems": 1
    },
    "variables": {
      "type": "array",
      "description": "Independent variables or manipulations",
      "items": {
        "type": "object",
        "required": ["name", "values"],
        "properties": {
          "name": {"type": "string"},
          "values": {"type": "array", "items": {"type": ["string", "number", "boolean"]}}
        }
      }
    },
    "controls": {
      "type": "array",
      "description": "Control or baseline settings",
      "items": {"type": "string"}
    },
    "metrics": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["name", "aggregation"],
        "properties": {
          "name": {"type": "string"},
          "aggregation": {"type": "string"},
          "stat_test": {"type": "string"}
        }
      }
    },
    "ablations": {
      "type": "array",
      "items": {"type": "string"}
    },
    "budget": {
      "type": "object",
      "required": ["max_runs", "max_compute_hours", "max_token_usage"],
      "properties": {
        "max_runs": {"type": "integer", "minimum": 1},
        "max_compute_hours": {"type": "number", "minimum": 0},
        "max_token_usage": {"type": "integer", "minimum": 0}
      }
    },
    "retry_policy": {
      "type": "object",
      "required": ["max_retries", "on_oom", "on_nan"],
      "properties": {
        "max_retries": {"type": "integer", "minimum": 0},
        "on_oom": {"type": "string"},
        "on_nan": {"type": "string"}
      }
    },
    "execution": {
      "type": "object",
      "description": "Execution constraints and mode",
      "properties": {
        "llm_mode": {"type": "string", "enum": ["api_inference"]},
        "allow_training": {"type": "boolean", "enum": [false]}
      }
    },
    "notes": {"type": "string"}
  }
}
